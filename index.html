<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>User Auth API Test</title>
</head>
<body>
  <h1>Auth API Test</h1>

  <!-- Sign In -->
  <h2>Sign In</h2>
  <form id="signinForm">
    <input type="email" id="signinEmail" placeholder="Email" required>
    <input type="password" id="signinPassword" placeholder="Password" required>
    <button type="submit">Sign In</button>
  </form>

  <p id="signinResult"></p>
  <p><b>Access Token:</b> <span id="accessTokenDisplay"></span></p>
  <p><b>Refresh Token:</b> <span id="refreshTokenDisplay"></span></p>

  <!-- Get Profile -->
  <h2>Profile</h2>
  <button id="getProfileBtn">Get Profile</button>
  <pre id="profileResult"></pre>

  <!-- Get Users (Admin / Super Admin only) -->
  <h2>Users</h2>
  <button id="getUsersBtn">Get All Users</button>
  <pre id="usersResult"></pre>

  <!-- Refresh Token -->
  <h2>Refresh Access Token</h2>
  <button id="refreshBtn">Refresh Token</button>
  <pre id="refreshResult"></pre>

  <!-- Logout -->
  <h2>Logout</h2>
  <form id="logoutForm">
    <input type="text" id="logoutRefreshToken" placeholder="Refresh Token" required>
    <button type="submit">Logout</button>
  </form>
  <p id="logoutResult"></p>

  <script>
    let accessToken = '';
    let refreshToken = '';

    // Base API URL
    const API_URL = 'http://localhost:5000/api'; // change if needed

    // ---- Signin ----
    document.getElementById('signinForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('signinEmail').value;
      const password = document.getElementById('signinPassword').value;

      try {
        const res = await fetch(`${API_URL}/signin`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        if (res.ok) {
          accessToken = data.accessToken;
          refreshToken = data.refreshToken;

          // Show tokens on page
          document.getElementById('signinResult').innerText = `Signed in as ${data.user.role}`;
          document.getElementById('accessTokenDisplay').innerText = accessToken;
          document.getElementById('refreshTokenDisplay').innerText = refreshToken;

          // Autofill logout input
          document.getElementById('logoutRefreshToken').value = refreshToken;
        } else {
          document.getElementById('signinResult').innerText = data.message;
        }
      } catch (err) {
        document.getElementById('signinResult').innerText = 'Error: ' + err.message;
      }
    });

    // ---- Profile ----
    document.getElementById('getProfileBtn').addEventListener('click', async () => {
      try {
        const res = await fetch(`${API_URL}/profile`, {
          headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        const data = await res.json();
        document.getElementById('profileResult').innerText = JSON.stringify(data, null, 2);
      } catch (err) {
        document.getElementById('profileResult').innerText = 'Error: ' + err.message;
      }
    });

    // ---- Get Users ----
    document.getElementById('getUsersBtn').addEventListener('click', async () => {
      try {
        const res = await fetch(`${API_URL}/users`, {
          headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        const data = await res.json();
        document.getElementById('usersResult').innerText = JSON.stringify(data, null, 2);
      } catch (err) {
        document.getElementById('usersResult').innerText = 'Error: ' + err.message;
      }
    });

    // ---- Refresh Token ----
    document.getElementById('refreshBtn').addEventListener('click', async () => {
      try {
        const res = await fetch(`${API_URL}/refresh`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ refreshToken })
        });
        const data = await res.json();
        if (res.ok) {
          accessToken = data.accessToken;
          refreshToken = data.refreshToken;

          document.getElementById('refreshResult').innerText = 'Token refreshed successfully!';
          document.getElementById('accessTokenDisplay').innerText = accessToken;
          document.getElementById('refreshTokenDisplay').innerText = refreshToken;
          document.getElementById('logoutRefreshToken').value = refreshToken;
        } else {
          document.getElementById('refreshResult').innerText = data.message;
        }
      } catch (err) {
        document.getElementById('refreshResult').innerText = 'Error: ' + err.message;
      }
    });

    // ---- Logout ----
    document.getElementById('logoutForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const refreshTokenInput = document.getElementById('logoutRefreshToken').value;

      try {
        const res = await fetch(`${API_URL}/logout`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
          },
          body: JSON.stringify({ refreshToken: refreshTokenInput })
        });
        const data = await res.json();
        document.getElementById('logoutResult').innerText = data.message;
      } catch (err) {
        document.getElementById('logoutResult').innerText = 'Error: ' + err.message;
      }
    });
  </script>
</body>
</html>
